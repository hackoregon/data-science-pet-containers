---
title: "TriMet Service Area Desire Lines"
author: "M. Edward (Ed) Borasky"
date: '2018-06-06'
output: html_notebook
bibliography: desire_lines.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lodes)
library(tidyverse)
library(stplanr)
library(sp)
library(tmap)
library(sf)

```

## Introduction
As part of the Hack Oregon 2018 season, TriMet gave the Transportation Systems team a dataset summarizing ridership metrics by service stop, totaled over three-month quarters. The ridership dataset covers March 2001 through November 2017, and includes breakdowns by weekday, Saturday and Sunday service.

To provide context for the weekday service, which includes commuters, we analyzed another dataset, the US Census Bureau's Longitudinal Employer-Household Dynamics (LEHD) [@LEHD2018] LEHD Origin-Destination Employment Statistics (LODES) data [@LODES2018a]. This dataset covers the years 2002 through 2015.

The LODES dataset provides job counts by the workers' home and work census blocks, where the blocks are defined by the 2010 decennial census [@LODES2018b]. We use the `lodes` package {@Rudis2017] to acquire the LODES data and `stplanr` [@Lovelace2018a] to compute the desire lines.

## Acquiring the LODES data

### Download the crosswalk files
First, we download the "crosswalk" files for Oregon and Washington. These files contain the geographic information for the census blocks. We filter in only the Portland - Vancouver - Hillsboro CBSA.
```{r message=FALSE}
xwalk <- bind_rows(
  read_xwalk("or", download_dir = "~/Raw/LODES") %>% 
    filter(cbsaname == "Portland-Vancouver-Hillsboro, OR-WA") %>% 
    select(-createdate),
  read_xwalk("wa", download_dir = "~/Raw/LODES") %>% 
    filter(cbsaname == "Portland-Vancouver-Hillsboro, OR-WA") %>% 
    select(-createdate)
)
xwalk$tabblk2010 <- as.character(xwalk$tabblk2010)
gc()

```

### Make the "zones" SpatialPointsDataFrame
The process `stplanr` uses to compute the desire lines has two inputs, the _flow_ and the _zones_ [@Lovelace2018a, vignette "Introducing stplanr"]. The `zones` data frame is a SpatialPointsDataFrame, as defined by the `sp` package [@Pebesma2005], that provides the coordinates of the interior points of the census blocks.
```{r}
zones <- SpatialPointsDataFrame(
  coords = select(xwalk, blklondd, blklatdd),
    data = select(xwalk, tabblk2010, blklondd, blklatdd),
    proj4string = CRS("+init=epsg:4269"))

```

### Make the `xwalk_4_joins` data frame
```{r}
xwalk_4_joins <- xwalk %>% 
  select(tabblk2010, cbsaname, stplcname, blklatdd, blklondd)

```

### Download the origin-destination data
The origin-destination data is split into two datasets, "main" and "aux". "Main" covers jobs where the workers live in the state; "aux" covers jobs where the workers live outside the state. Because some Oregon workers live in Washington and vice versa, we acquire both "main" and "aux" for Oregon and Washington.
```{r message=FALSE, warning=FALSE, error=FALSE, results='hide'}
# define a fucntion to fetch a file
fetch_od <- function(state, segment, ixyear, xwalk_4_joins) {
  temp <-read_lodes(
    state, "od", segment, "JT00", ixyear, download_dir = "~/Raw/LODES")
  temp$w_geocode <- as.character(temp$w_geocode)
  temp$h_geocode <- as.character(temp$h_geocode)
  temp <- temp %>% 
    semi_join(xwalk_4_joins, by = c("w_geocode" = "tabblk2010"))
  temp <- temp %>% 
    semi_join(xwalk_4_joins, by = c("h_geocode" = "tabblk2010")) 
  temp <- temp %>% mutate(year = ixyear)
  temp <- temp  %>% select(-createdate)
  gc()
  return(temp)
}

metro_od <- tibble()
for (ixyear in 2002:2015) {
  for (state in c("or", "wa")) {
    for (type in c("main", "aux")) {
      temp <- fetch_od(state, type, ixyear, xwalk_4_joins)
      metro_od <- metro_od %>% bind_rows(temp)
      rm(temp); gc()
    }
  }
}

```

### Download the residence area characteristics data
Because we have workers who live and work in both Washington and Oregon, we download both states' residence and workplace area characteristics.
```{r message=FALSE, warning=FALSE, error=FALSE, results='hide'}
fetch_rac <- function(state, ixyear, xwalk_4_joins) {
  temp <-read_lodes(
    state, "rac", "S000", "JT00", ixyear, download_dir = "~/Raw/LODES")
  temp$h_geocode <- as.character(temp$h_geocode)
  temp <- temp %>% select(-createdate)
  temp <- temp %>% mutate(year = ixyear) 
  temp <- temp %>% 
    inner_join(xwalk_4_joins, by = c("h_geocode" = "tabblk2010"))
  gc()
  return(temp)
}

metro_rac <- tibble()
for (ixyear in 2002:2015) {
  for (state in c("or", "wa")) {
    temp <- fetch_rac(state, ixyear, xwalk_4_joins)
    metro_rac <- metro_rac %>% bind_rows(temp)
    rm(temp); gc()
  }
}

metro_rac <- SpatialPointsDataFrame(
  coords = select(metro_rac, blklondd, blklatdd),
  data = metro_rac
)
gc()
metro_rac <- metro_rac %>% as("sf")
gc()

```

### Plot top 50 residence areas
We make interactive maps with `qtm` from `tmap` [@Tennekes2018]. This is a Leaflet map. The "+" and "-" buttons can be used to zoom in and out and you can drag the map around with the mouse. You can select the basemap and whether to display plotted features with the "layers" button below the "-". If you click on one of the circles you'll see the number of workers.

```{r}
tmap_mode("view")
qtm(
  metro_rac %>% 
    filter(year == 2015) %>% 
    mutate(Workers = C000) %>% 
    arrange(desc(Workers)) %>% 
    top_n(50, Workers),
  symbols.col = "Workers",
  symbols.size = "Workers"
)
save_tmap(filename = "metro_rac_2015.html")

```

### Download the workplace area characteristics data
```{r message=FALSE, warning=FALSE, error=FALSE, results='hide'}
fetch_wac <- function(state, ixyear, xwalk_4_joins) {
  temp <-read_lodes(
    state, "wac", "S000", "JT00", ixyear, download_dir = "~/Raw/LODES")
  temp$w_geocode <- as.character(temp$w_geocode)
  temp <- temp %>% select(-createdate)
  temp <- temp %>% mutate(year = ixyear) 
  temp <- temp %>% 
    inner_join(xwalk_4_joins, by = c("w_geocode" = "tabblk2010"))
  gc()
  return(temp)
}

metro_wac <- tibble()
for (ixyear in 2002:2015) {
  for (state in c("or", "wa")) {
    temp <- fetch_wac(state, ixyear, xwalk_4_joins)
    metro_wac <- metro_wac %>% bind_rows(temp)
    rm(temp); gc()
  }
}

metro_wac <- SpatialPointsDataFrame(
  coords = select(metro_wac, blklondd, blklatdd),
  data = metro_wac
)
gc()
metro_wac <- metro_wac %>% as("sf")
gc()

```

## Plot the workplace map
This map shows the dominance of the West Side for jobs. The large circle near the Willamette is the OHSU complex on Marquam Hill. On the MAX Blue Line, the two circles in Hillsboro and Orenco are Intel, the 9,205-worker circle in Beaverton is Nike, and the 4,611-worker circle near the Sunset Highway - 217 interchange is the St. Vincent's complex.
```{r}
tmap_mode("view")
qtm(
  metro_wac %>% 
    filter(year == 2015) %>% 
    mutate(Workers = C000) %>% 
    arrange(desc(Workers)) %>% 
    top_n(50, Workers),
  symbols.col = "Workers",
  symbols.size = "Workers"
)
save_tmap(filename = "metro_wac_2015.html")

```
## Computing the desire lines

### Flow by residence
To compute the desire lines, `stplanr` needs two datasets - the `flow` and the `zones`. The zones don't change - they're simply a table of the spatial locations of the census blocks, and we've already computed them.

But there are two ways we can look at the flows - from residence to workplace or the other way around. Let's look at the desire lines for residence to workplace for 2015 first.

The top residence areas:
```{r}
residence_2015 <- metro_rac %>% 
  filter(year == 2015) %>% 
  mutate(Workers = C000) %>% 
  select(-C000:-CS02) %>% 
  arrange(desc(Workers)) %>% 
  top_n(20, Workers)
```

And the flows. We remove flows where the home and work geocode are the same.
```{r}
residence_flow_2015 <- metro_od %>% 
  filter(
    year == 2015,
    w_geocode != h_geocode
  ) %>% 
  semi_join(residence_2015, by = "h_geocode") %>% 
  select(w_geocode, h_geocode, Workers = S000) %>% 
  arrange(desc(Workers)) %>% 
  top_n(100, Workers)

```

### Compute the desire lines
```{r}
residence_desire_lines_2015 <-
  od2line(flow = residence_flow_2015, zones = zones)

```

### Plot the desire lines
This map shows the desire lines from the point of view of the workers - where should the service stops and routes be to get them to work and back home.
```{r}
tmap_mode("view")
qtm(
  residence_desire_lines_2015, 
  lines.lwd = "Workers", 
  lines.scale = 10, 
  lines.col = "firebrick"
) + 
qtm(residence_2015, symbols.scale = 2, symbols.size = "Workers", symbols.col = "Workers")
save_tmap(filename = "residence_desire_lines_2015.html")

```

### Flow by workplace
```{r}
workplace_2015 <- metro_wac %>% 
  filter(year == 2015) %>% 
  mutate(Workers = C000) %>% 
  select(-C000:-CSF05) %>% 
  arrange(desc(Workers)) %>% 
  top_n(20, Workers)
workplace_flow_2015 <- metro_od %>% 
  filter(
    year == 2015,
    w_geocode != h_geocode
  ) %>% 
  semi_join(workplace_2015, by = "w_geocode") %>% 
  select(w_geocode, h_geocode, Workers = S000) %>% 
  arrange(desc(Workers)) %>% 
  top_n(100, Workers)

workplace_desire_lines_2015 <-
  od2line(flow = workplace_flow_2015, zones = zones)
```

This map shows the desire lines from the point of view of the employers - where should the service stops and routes be to deliver workers to their jobs.
```{r}
tmap_mode("view")
qtm(
  workplace_desire_lines_2015, 
  lines.lwd = "Workers", 
  lines.scale = 10, 
  lines.col = "firebrick"
) + 
qtm(workplace_2015, symbols.scale = 2, symbols.size = "Workers", symbols.col = "Workers")
save_tmap(filename = "workplace_desire_lines_2015.html")

```

  semi_join(top_metro_workplaces_2002, by = "w_geocode") %>% 
  select(w_geocode, h_geocode, jobs = S000) %>% 
  arrange(desc(jobs)) %>% top_n(20, jobs)
```

Compute the desire lines with `od2line` from `stplanr` [@Lovelace2018a].
```{r}
desire_lines_metro_2002 <- od2line(flow_metro_2002, zones)
```

```{r}
tmap_mode("view")
qtm(
  desire_lines_metro_2002, 
  lines.lwd = "jobs", 
  lines.scale = 10, 
  lines.col = "firebrick"
) + 
qtm(top_metro_workplaces_2002, symbols.scale = 2, symbols.size = "jobs", symbols.col = "jobs") +
qtm(top_metro_residences_2002, symbols.scale = 2, symbols.size = "workers", symbols.col = "darkgreen")
save_tmap(filename = "desire_lines_metro_2002.html")
```

### Metro 2015
Let's repeat the process for the last year in our dataset, 2015.
```{r}
top_metro_workplaces_2015 <- metro_workplaces %>% 
  filter(year == 2015) %>% 
  mutate(jobs = S000) %>% arrange(desc(jobs)) %>% top_n(15, jobs)

top_metro_residences_2015 <- metro_workers %>% 
  filter(year == 2015) %>% 
  mutate(workers = S000) %>% arrange(desc(workers)) %>% top_n(15, workers)

flow_metro_2015 <- metro_od %>% filter(
  year == 2015,
  w_geocode != h_geocode) %>% 
  semi_join(top_metro_workplaces_2015, by = "w_geocode") %>% 
  select(w_geocode, h_geocode, jobs = S000) %>% 
  arrange(desc(jobs)) %>% top_n(20, jobs)

desire_lines_metro_2015 <- od2line(flow_metro_2015, zones)
```

The dominance of the west side in 2015 is even more pronounced. And the census block containing the OHSU complex is the dominant workplace in the region, with over 15,000 jobs! Our next map will focus on the city of Portland and remove OHSU.
```{r}
tmap_mode("view")
qtm(
  desire_lines_metro_2015, 
  lines.lwd = "jobs", 
  lines.scale = 5, 
  lines.col = "firebrick"
) + 
qtm(top_metro_workplaces_2015, symbols.scale = 2, symbols.size = "jobs", symbols.col = "jobs") +
qtm(top_metro_residences_2015, symbols.scale = 2, symbols.size = "workers", symbols.col = "darkgreen")
save_tmap(filename = "desire_lines_metro_2015.html")

```

### City of Portland (minus OHSU) 2015
To see the flows with the city of Portland, we have to remove the census block containing the OHSU complex, `410510058002014`.
```{r}
top_portland_workplaces_2015 <- portland_workplaces %>% 
  filter(year == 2015,
  w_geocode != "410510058002014") %>% 
  mutate(jobs = S000) %>% arrange(desc(jobs)) %>% top_n(15, jobs)

flow_portland_2015 <- metro_od %>% filter(
  year == 2015,
  w_geocode != h_geocode) %>% 
  semi_join(top_portland_workplaces_2015, by = "w_geocode") %>% 
  select(w_geocode, h_geocode, jobs = S000) %>% 
  arrange(desc(jobs)) %>% top_n(20, jobs)

desire_lines_portland_2015 <- od2line(flow_portland_2015, zones)
```

With the focus on the city of Portland with OHSU removed, you can see the diversity of the commuters' transit needs.
```{r}
tmap_mode("view")
qtm(
  desire_lines_portland_2015, 
  lines.lwd = "jobs", 
  lines.scale = 5, 
  lines.col = "firebrick"
) + 
qtm(top_portland_workplaces_2015, symbols.scale = 2, symbols.size = "jobs", symbols.col = "jobs") +
qtm(top_metro_residences_2015, symbols.scale = 2, symbols.size = "workers", symbols.col = "darkgreen")
save_tmap(filename = "desire_lines_portland_2015.html")
```

## Session info
```{r}
devtools::session_info()
```
## References
