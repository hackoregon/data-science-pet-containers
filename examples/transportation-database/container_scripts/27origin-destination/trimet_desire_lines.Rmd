---
title: "TriMet Service Area Desire Lines"
author: "M. Edward (Ed) Borasky"
date: '2018-06-06'
output:
  html_document:
    df_print: paged
bibliography: desire_lines.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lodes)
library(tidyverse)
library(stplanr)
library(sp)
library(tmap)
library(sf)
```

## Introduction
As part of the Hack Oregon 2018 season, TriMet gave the Transportation Systems team a dataset summarizing ridership metrics by service stop, totaled over three-month quarters. The ridership dataset covers March 2001 through November 2017, and includes breakdowns by weekday, Saturday and Sunday service.

To provide context for the weekday service, which includes commuters, we analyzed another dataset, the US Census Bureau's Longitudinal Employer-Household Dynamics (LEHD) [@LEHD2018] LEHD Origin-Destination Employment Statistics (LODES) data [@LODES2018]. This dataset covers the years 2002 through 2015.

The LODES dataset provides job counts by the workers' home and work census blocks, where the blocks are defined by the 2010 decennial census. We use the `lodes` package {@Rudis2017] to acquire the LODES data and `stplanr` [Lovelace2018a] to compute the desire lines.

## Acquiring the LODES data

### Downloading the crosswalk file
First, we download the "crosswalk" file for Oregon. This file contains the geographic information for the census blocks.
```{r message=FALSE}
or_xwalk <- read_xwalk("or", download_dir = "~/Raw")
or_xwalk$tabblk2010 <- as.character(or_xwalk$tabblk2010) 
```
### Downloading the origin-destination data
```{r message=FALSE, warning=FALSE, error=FALSE, results='hide'}
or_od_main_JT00 <- tibble()
for (ixyear in 2002:2015) {
  temp <-   read_lodes("or", "od", "main", "JT00", ixyear, download_dir = "~/Raw")
  temp$w_geocode <- as.character(temp$w_geocode)
  temp$h_geocode <- as.character(temp$h_geocode)
  temp <- temp %>% mutate(year = ixyear) %>% select(-createdate)
  or_od_main_JT00 <- or_od_main_JT00 %>% bind_rows(temp)
  rm(temp); gc()
}
```

### Filtering down to the TriMet service area
The TriMet service area is contained in three Oregon counties - Clackamas, Multnomah and Washington. So we define a function to filter in those three counties.
```{r}
is_trimet_area <- function(census_fips_code) {
  county_fips_code <- substr(census_fips_code, 1, 5)
  
  # Clackamas = "41005"
  # Multnomah = "41051"
  # Washington = "41067"
  return(
    county_fips_code == "41005" |
      county_fips_code == "41051" |
      county_fips_code == "41067"
  )
}
```


## Aggregate and geotag the job counts
```{r}
or_workplaces <- or_od_main_JT00 %>% 
  group_by(year, w_geocode) %>% 
  summarize(jobs = sum(S000)) %>% ungroup() %>% arrange(year, desc(jobs)) %>% 
  left_join(or_xwalk, by = c("w_geocode" = "tabblk2010")) %>% 
  select(year, w_geocode, blklondd, blklatdd, jobs) 
or_workplaces <- SpatialPointsDataFrame(
  coords = select(or_workplaces, blklondd, blklatdd),
    data = select(or_workplaces, year, w_geocode, blklondd, blklatdd, jobs),
    proj4string = CRS("+init=epsg:4269")
) %>% st_as_sf()
```

### Make the "zones" data frame
The process `stplanr` uses to compute the desire lines has two inputs, the _flow_ and the _zones_ [@Lovelace2018a, vignette "Introducing stplanr"]. The `zones` data frame is a SpatialPointsDataFrame as defined by the `sp` package [@Pebesma2005, @Bivand2013]
```{r}
zones <- SpatialPointsDataFrame(
  coords = select(or_xwalk, blklondd, blklatdd),
    data = select(or_xwalk, tabblk2010, blklondd, blklatdd),
    proj4string = CRS("+init=epsg:4269"))
```


## Computing the desire lines

### Computing the flows
```{r}
top_metro_workplaces_2002 <- or_workplaces %>% filter(
  is_trimet_area(w_geocode),
  year == 2002
) %>% arrange(desc(jobs)) %>% top_n(20, jobs)

flow_metro_2002 <- or_od_main_JT00 %>% filter(year == 2002) %>% 
  semi_join(top_metro_workplaces_2002, by = "w_geocode") %>% 
  select(w_geocode, h_geocode, jobs = S000) %>% filter(jobs > 4)

top_metro_workplaces_2015 <- or_workplaces %>% filter(
  is_trimet_area(w_geocode),
  year == 2015
) %>% arrange(desc(jobs)) %>% top_n(20, jobs)

flow_metro_2015 <- or_od_main_JT00 %>% filter(year == 2015) %>% 
  semi_join(top_metro_workplaces_2015, by = "w_geocode") %>% 
  select(w_geocode, h_geocode, jobs = S000) %>% filter(jobs > 4)
```

### Make the desire lines
```{r}
  
desire_lines_metro_2002 <- od2line(flow_metro_2002, zones)
desire_lines_metro_2015 <- od2line(flow_metro_2015, zones)
```

### Plot 2002
```{r}
tmap_mode("view")
qtm(
  desire_lines_metro_2002, 
  lines.lwd = "jobs", 
  lines.scale = 5, 
  lines.col = "firebrick"
) + 
  qtm(
    top_metro_workplaces_2002, 
    symbols.col = "jobs", 
    symbols.size = "jobs", 
    symbols.scale = 1)
save_tmap(filename = "desire_lines_metro_2002.html")
```

### Plot 2015
```{r}
qtm(
  desire_lines_metro_2015, 
  lines.lwd = "jobs", 
  lines.scale = 5, 
  lines.col = "firebrick"
) + 
  qtm(
    top_metro_workplaces_2015, 
    symbols.col = "jobs", 
    symbols.size = "jobs", 
    symbols.scale = 1
  )
save_tmap(filename = "desire_lines_metro_2015.html")

```

### City of Portland (minus OHSU) 2015
```{r}
portland_xwalk <- or_xwalk %>% filter(stplcname == "Portland city, OR")

# The census block containing OHSU is so big (over 16,000 jobs) that it obscures
# the other workplaces in Portland. So we filter it out.
top_portland_workplaces_2015 <- or_workplaces %>% 
  filter(year == 2015, jobs < 10000) %>% 
  semi_join(portland_xwalk, by = c("w_geocode" = "tabblk2010")) %>% 
  arrange(desc(jobs)) %>% top_n(20, jobs)

flow_portland_2015 <- or_od_main_JT00 %>% filter(year == 2015) %>% 
  semi_join(top_portland_workplaces_2015, by = "w_geocode") %>% 
  select(w_geocode, h_geocode, jobs = S000) %>% filter(jobs > 4)

desire_lines_portland_2015 <- od2line(flow_portland_2015, zones)

qtm(
  desire_lines_portland_2015, 
  lines.lwd = "jobs", 
  lines.scale = 5, 
  lines.col = "firebrick"
) + 
  qtm(
    top_portland_workplaces_2015, 
    symbols.col = "jobs", 
    symbols.size = "jobs", 
    symbols.scale = 1
  )
save_tmap(filename = "desire_lines_portland_2015.html")
```


## Session info
```{r}
devtools::session_info()
```
## References
