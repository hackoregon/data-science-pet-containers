---
title: "TriMet Service Area Desire Lines"
author: "M. Edward (Ed) Borasky"
date: '2018-06-06'
output:
  html_document:
    df_print: paged
bibliography: desire_lines.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lodes)
library(tidyverse)
library(stplanr)
library(sp)
library(tmap)
library(sf)
```

## Introduction
As part of the Hack Oregon 2018 season, TriMet gave the Transportation Systems team a dataset summarizing ridership metrics by service stop, totaled over three-month quarters. The ridership dataset covers March 2001 through November 2017, and includes breakdowns by weekday, Saturday and Sunday service.

To provide context for the weekday service, which includes commuters, we analyzed another dataset, the US Census Bureau's Longitudinal Employer-Household Dynamics (LEHD) [@LEHD2018] LEHD Origin-Destination Employment Statistics (LODES) data [@LODES2018a]. This dataset covers the years 2002 through 2015.

The LODES dataset provides job counts by the workers' home and work census blocks, where the blocks are defined by the 2010 decennial census [@LODES2018b]. We use the `lodes` package {@Rudis2017] to acquire the LODES data and `stplanr` [@Lovelace2018a] to compute the desire lines.

## Acquiring the LODES data

### Downloading the crosswalk file
First, we download the "crosswalk" files for Oregon and Washington. These files contain the geographic information for the census blocks.
```{r message=FALSE}
xwalk <- bind_rows(
  read_xwalk("or", download_dir = "~/Raw"),
  read_xwalk("wa", download_dir = "~/Raw")
)
xwalk$tabblk2010 <- as.character(xwalk$tabblk2010) 
```

### Downloading the origin-destination data
The origin-destination data is split into two datasets, "main" and "aux". "Main" covers jobs where the workers live in Oregon; "aux" covers jobs where the workers live outside the state. Because some Portland workers live in Washington, we include the "aux" files.
```{r message=FALSE, warning=FALSE, error=FALSE, results='hide'}
or_od_JT00 <- tibble()
for (ixyear in 2002:2015) {
  
  #main
  temp <-   read_lodes("or", "od", "main", "JT00", ixyear, download_dir = "~/Raw")
  temp$w_geocode <- as.character(temp$w_geocode)
  temp$h_geocode <- as.character(temp$h_geocode)
  temp <- temp %>% 
    semi_join(xwalk, by = c("w_geocode" = "tabblk2010")) %>% 
    semi_join(xwalk, by = c("h_geocode" = "tabblk2010")) %>% 
    mutate(year = ixyear) %>% 
    select(-createdate)
  or_od_JT00 <- or_od_JT00 %>% bind_rows(temp)
  rm(temp); gc()
  
  #aux
  temp <-   read_lodes("or", "od", "aux", "JT00", ixyear, download_dir = "~/Raw")
  temp$w_geocode <- as.character(temp$w_geocode)
  temp$h_geocode <- as.character(temp$h_geocode)
  temp <- temp %>% 
    semi_join(xwalk, by = c("w_geocode" = "tabblk2010")) %>% 
    semi_join(xwalk, by = c("h_geocode" = "tabblk2010")) %>% 
    mutate(year = ixyear) %>% 
    select(-createdate)
  or_od_JT00 <- or_od_JT00 %>% bind_rows(temp)
  rm(temp); gc()
}
```

### Workplace analysis
First, we need to define the geographical properties of workplaces. To do this, we create an aggregated data frame with the `tidyverse` [@Wickham2017], convert it to a SpatialPointsDataFrame with `sp` ([@Pebesma2005] and then to a simple features data frame with `sf` [@Bivand2013]. The result is a tidyverse-enabled geotagged data frame `or_workplaces`.
```{r}
## sum all the job counts by year and workplace census block (w_geocode)
or_workplaces <- or_od_JT00 %>% 
  group_by(year, w_geocode) %>%
  summarize_at(.funs = sum, .vars = vars(S000:SI03)) %>% 
  left_join(xwalk, by = c("w_geocode" = "tabblk2010")) %>% 
  select(
    year, w_geocode, S000:SI03,
    cbsaname, stplcname,
    blklondd, blklatdd
  ) %>% 
  ungroup()
  gc()

## convert to a "simple features" data frame
or_workplaces <- SpatialPointsDataFrame(
  coords = or_workplaces %>% select(blklondd, blklatdd),
  data = or_workplaces,
  proj4string = CRS("+init=epsg:4269")
) %>% st_as_sf()
  gc()
```

### Residence analysis
We also need to define the geographical properties of workers' residences. To do this, we use the same process we used for the workplaces, keying off the *residence* census block `h_geocode`. The result is a tidyverse-enabled geotagged data frame `or_workers`.
```{r}
## sum all the job counts by year and residence census block (h_geocode)
or_workers <- or_od_JT00 %>% 
  group_by(year, h_geocode) %>%
  summarize_at(.funs = sum, .vars = vars(S000:SI03)) %>% 
  left_join(xwalk, by = c("h_geocode" = "tabblk2010")) %>% 
  select(
    year, h_geocode, S000:SI03,
    cbsaname, stplcname,
    blklondd, blklatdd
  ) %>% 
  ungroup()
  gc()

## convert to a "simple features" data frame
or_workers <- SpatialPointsDataFrame(
  coords = or_workers %>% select(blklondd, blklatdd),
  data = or_workers,
  proj4string = CRS("+init=epsg:4269")
) %>% st_as_sf()
  gc()
```

### Make the "zones" data frame
The process `stplanr` uses to compute the desire lines has two inputs, the _flow_ and the _zones_ [@Lovelace2018a, vignette "Introducing stplanr"]. The `zones` data frame is a SpatialPointsDataFrame, as defined by the `sp` package [@Pebesma2005], that provides the coordinates of the interior points of the census blocks.
```{r}
zones <- SpatialPointsDataFrame(
  coords = select(xwalk, blklondd, blklatdd),
    data = select(xwalk, tabblk2010, blklondd, blklatdd),
    proj4string = CRS("+init=epsg:4269"))
```

## Computing the desire lines

### Metro 2002
We start by tabulating the top 10 Oregon workplaces in the Portland metro area. We use `S000` (all jobs) as the jobs count [@LODES2018b].
```{r}
top_metro_workplaces_2002 <- or_workplaces %>% filter(
  cbsaname == "Portland-Vancouver-Hillsboro, OR-WA",
  year == 2002
) %>% 
  mutate(jobs = S000) %>% arrange(desc(jobs)) %>% top_n(10, jobs)
```

Tabulate the top 10 residences in the Portland metro area. We use `S000` (all jobs) as the workers count [@LODES2018b].
```{r}
top_metro_residences_2002 <- or_residences %>% filter(
  cbsaname == "Portland-Vancouver-Hillsboro, OR-WA",
  year == 2002
) %>% 
  mutate(workers = S000) %>% arrange(desc(workers)) %>% top_n(10, workers)
```

Now compute the flow - number of commuters into the workplaces by home and work census blocks. To keep things simple we only take the top 10 entries. We remove entries where the home and work census blocks are the same.
```{r}
flow_metro_2002 <- or_od_JT00 %>% filter(
  year == 2002,
  w_geocode != h_geocode) %>% 
  semi_join(top_metro_workplaces_2002, by = "w_geocode") %>% 
  select(w_geocode, h_geocode, jobs = S000) %>% 
  arrange(desc(jobs)) %>% top_n(10, jobs)
```

Compute the desire lines with `od2line` from `stplanr` [@Lovelace2018a].
```{r}
desire_lines_metro_2002 <- od2line(flow_metro_2002, zones)
```

#### Make an interactive map with `qtm` from `tmap` [@Tennekes2018]. 
This is a Leaflet map. The "+" and "-" buttons can be used to zoom in and out and you can drag the map around with the mouse. You can select the basemap and whether to display the desire lines and workplace circles with the "layers" button below the "-". If you click on one of the circles you'll see the number of jobs.

Note that the bulk of the top 10 workplaces / desire lines are on the west side. The three leftmost points are Intel in Hillsboro. The cluster of three points in Beaverton are Nike and Tektronix. The dark orange (9728 jobs) circle near the Willamette is the OHSU complex, and the circle near the 217 - 26 interchange (4368 jobs) is Providence St. Vincent's. 
```{r}
tmap_mode("view")
qtm(
  desire_lines_metro_2002, 
  lines.lwd = "jobs", 
  lines.scale = 5, 
  lines.col = "firebrick"
) + 
qtm(top_metro_workplaces_2002, symbols.scale = 1, symbols.col = "jobs")
save_tmap(filename = "desire_lines_metro_2002.html")
```

### Metro 2015
Let's repeat the process for the last year in our dataset, 2015.
```{r}
top_metro_workplaces_2015 <- or_workplaces %>% filter(
  cbsaname == "Portland-Vancouver-Hillsboro, OR-WA",
  year == 2015
) %>% 
  mutate(jobs = S000) %>% arrange(desc(jobs)) %>% top_n(10, jobs)

flow_metro_2015 <- or_od_JT00 %>% filter(
  year == 2015,
  w_geocode != h_geocode) %>% 
  semi_join(top_metro_workplaces_2015, by = "w_geocode") %>% 
  select(w_geocode, h_geocode, jobs = S000) %>% 
  arrange(desc(jobs)) %>% top_n(10, jobs)

desire_lines_metro_2015 <- od2line(flow_metro_2015, zones)
```

The dominance of the west side in 2015 is even more pronounced. And the census block containing the OHSU complex is the dominant workplace in the region, with over 16,000 jobs! Our next map will focus on the city of Portland and remove OHSU.
```{r}
tmap_mode("view")
qtm(
  desire_lines_metro_2015, 
  lines.lwd = "jobs", 
  lines.scale = 5, 
  lines.col = "firebrick"
) + qtm(
  top_metro_workplaces_2015, symbols.scale = 1, symbols.col = "jobs")
save_tmap(filename = "desire_lines_metro_2015.html")

```

### City of Portland (minus OHSU) 2015
To see the flows with the city of Portland, we have to remove the census block containing the OHSU complex, `410510058002014`.
```{r}
top_portland_workplaces_2015 <- or_workplaces %>% filter(
  stplcname == "Portland city, OR",
  year == 2015,
  w_geocode != "410510058002014"
) %>% 
  mutate(jobs = S000) %>% arrange(desc(jobs)) %>% top_n(10, jobs)

flow_portland_2015 <- or_od_JT00 %>% filter(
  year == 2015,
  w_geocode != h_geocode) %>% 
  semi_join(top_portland_workplaces_2015, by = "w_geocode") %>% 
  select(w_geocode, h_geocode, jobs = S000) %>% 
  arrange(desc(jobs)) %>% top_n(10, jobs)

desire_lines_portland_2015 <- od2line(flow_portland_2015, zones)
```

With the focus on the city of Portland with OHSU removed, you can see the diversity of the commuters' transit needs.
```{r}
tmap_mode("view")
qtm(
  desire_lines_portland_2015, 
  lines.lwd = "jobs", 
  lines.scale = 5, 
  lines.col = "firebrick"
) + qtm(
  top_portland_workplaces_2015, symbols.scale = 1, symbols.col = "jobs")
save_tmap(filename = "desire_lines_portland_2015.html")
```

## Session info
```{r}
devtools::session_info()
```
## References
